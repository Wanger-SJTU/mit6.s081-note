# 概述

xv6 的文件系统分7层实现，如图8-1所示。

<img src="/Users/hwstaff/Desktop/截屏2021-06-17 上午12.53.08.png" alt="截屏2021-06-17 上午12.53.08" style="zoom:40%;" />

<center>图8-1</center>

- Disk层通过读写block实现了对磁盘的IO访问
- Buffer cache 层缓存了磁盘block，同步了对磁盘的访问，保证同时只有一个内核进程可以修改磁盘块
- logging 层使得更高层的接口可以将对磁盘的更新按会话打包，通过会话的方式来保证这些操作是原子操作（要么都被应用，要么都不被应用）。
- inode层提供独立的文件访问，每个node通过一个 唯一的i 节点标识文件，并通过一连串的数据块（block）实现文件内容管理。
- 目录层，作为特殊的 i 节点（inode），内容是一连串的目录项，每一个目录项包含一个文件名和对应的 i 节点。
- 第五层提供了层次路经名（如/usr/rtm/xv6/fs.c这样的），这一层通过递归的方式来查询路径对应的文件。
- 文件描述符将许多 UNIX 的资源（如管道，设备，文件等）抽象为文件系统的接口，极大地简化了程序员的工作。

文件系统必须设计好在磁盘上的什么地方放置 inode和数据块。如图所示，xv6 把磁盘划分为几个部分。文件系统不使用第0块（第0块预留作为 bootloader）。第1块叫做*超级块*（superblock）；包含了文件系统的元信息（如文件系统的总块数，数据块块数，i node数目，以及日志的块数）。从第2块开始存放 log。接下来的块存放空闲块信息的位图（bitmap）。剩下的大部分块是数据块，要么保存了文件和目录的内容，要么是闲置未用的。*超级块*中是独立的程序，mkfs，这部分创建了最初的文件系统。

![截屏2021-06-18 上午12.02.34](/Users/hwstaff/Desktop/截屏2021-06-18 上午12.02.34.png)